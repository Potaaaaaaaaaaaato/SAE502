#!/bin/bash
# PostgreSQL Backup Script
# Generated by Ansible for {{ project_name }}
# Backs up database and applies rotation

set -e

BACKUP_DIR="{{ backup_dir }}"
PROJECT_ROOT="{{ project_root }}"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
BACKUP_FILE="$BACKUP_DIR/backup_$TIMESTAMP.sql.gz"
RETENTION_DAYS={{ backup_retention_days }}

echo "[$(date)] Starting PostgreSQL backup..."

# Perform backup using docker compose
cd $PROJECT_ROOT/app/docker
docker compose exec -T postgresql pg_dump -U {{ db_user }} {{ db_name }} | gzip > "$BACKUP_FILE"

if [ -f "$BACKUP_FILE" ]; then
    echo "[$(date)] Backup completed successfully: $BACKUP_FILE"
    echo "[$(date)] Backup size: $(du -h $BACKUP_FILE | cut -f1)"
    
    # Delete backups older than retention period
    echo "[$(date)] Cleaning up old backups (older than $RETENTION_DAYS days)..."
    find $BACKUP_DIR -name "backup_*.sql.gz" -type f -mtime +$RETENTION_DAYS -delete
    
    echo "[$(date)] Backup rotation complete"
    echo "[$(date)] Current backup count: $(ls -1 $BACKUP_DIR/backup_*.sql.gz 2>/dev/null | wc -l)"
else
    echo "[$(date)] ERROR: Backup failed!"
    exit 1
fi
