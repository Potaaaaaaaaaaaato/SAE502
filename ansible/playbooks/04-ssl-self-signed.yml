---
# Playbook 04: Configure SSL/TLS with Self-Signed Certificate
# For demo/staging environments without a public domain
# Generates a self-signed certificate for HTTPS testing

- name: Configure SSL/TLS with Self-Signed Certificate
  hosts: all
  become: yes
  gather_facts: yes

  tasks:
    - name: Display SSL configuration info
      debug:
        msg: "Configuring self-signed SSL certificate for {{ domain_name }}"

    - name: Install OpenSSL
      apt:
        name: openssl
        state: present

    - name: Create SSL directory for certificates
      file:
        path: "{{ project_root }}/app/docker/nginx/ssl"
        state: directory
        owner: "{{ deploy_user }}"
        group: "{{ deploy_group }}"
        mode: '0755'

    - name: Generate private key
      become_user: "{{ deploy_user }}"
      command: >
        openssl genrsa -out {{ project_root }}/app/docker/nginx/ssl/privkey.pem 2048
      args:
        creates: "{{ project_root }}/app/docker/nginx/ssl/privkey.pem"

    - name: Generate self-signed certificate
      become_user: "{{ deploy_user }}"
      command: >
        openssl req -new -x509 -key {{ project_root }}/app/docker/nginx/ssl/privkey.pem
        -out {{ project_root }}/app/docker/nginx/ssl/fullchain.pem
        -days 365
        -subj "/C=FR/ST=France/L=Paris/O=SAE502/OU=Demo/CN={{ domain_name }}"
      args:
        creates: "{{ project_root }}/app/docker/nginx/ssl/fullchain.pem"

    - name: Set correct permissions on SSL files
      file:
        path: "{{ item }}"
        owner: "{{ deploy_user }}"
        group: "{{ deploy_group }}"
        mode: '0644'
      loop:
        - "{{ project_root }}/app/docker/nginx/ssl/privkey.pem"
        - "{{ project_root }}/app/docker/nginx/ssl/fullchain.pem"

    - name: Verify certificate was created
      stat:
        path: "{{ project_root }}/app/docker/nginx/ssl/fullchain.pem"
      register: cert_check

    - name: Display certificate info
      command: >
        openssl x509 -in {{ project_root }}/app/docker/nginx/ssl/fullchain.pem
        -noout -subject -dates
      register: cert_info
      when: cert_check.stat.exists

    - name: Show certificate details
      debug:
        var: cert_info.stdout_lines
      when: cert_check.stat.exists

    - name: Create Nginx HTTPS configuration
      become_user: "{{ deploy_user }}"
      copy:
        dest: "{{ project_root }}/app/docker/nginx/nginx.conf"
        content: |
          upstream django {
              server django-app:8000;
          }

          # Redirect HTTP to HTTPS
          server {
              listen 80;
              server_name {{ domain_name }};
              
              location /.well-known/acme-challenge/ {
                  root /var/www/certbot;
              }
              
              location / {
                  return 301 https://$host$request_uri;
              }
          }

          # HTTPS Server
          server {
              listen 443 ssl http2;
              server_name {{ domain_name }};

              # SSL Configuration
              ssl_certificate /etc/letsencrypt/fullchain.pem;
              ssl_certificate_key /etc/letsencrypt/privkey.pem;
              
              # SSL Security Settings
              ssl_protocols TLSv1.2 TLSv1.3;
              ssl_prefer_server_ciphers on;
              ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256;
              ssl_session_cache shared:SSL:10m;
              ssl_session_timeout 10m;

              # Security Headers
              add_header X-Frame-Options "SAMEORIGIN" always;
              add_header X-Content-Type-Options "nosniff" always;
              add_header X-XSS-Protection "1; mode=block" always;
              add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

              # Gzip compression
              gzip on;
              gzip_types text/plain text/css application/json application/javascript text/xml application/xml;

              # Static files
              location /static/ {
                  alias /app/staticfiles/;
                  expires 30d;
                  add_header Cache-Control "public, immutable";
              }

              # Media files
              location /media/ {
                  alias /app/mediafiles/;
                  expires 7d;
              }

              # Django application
              location / {
                  proxy_pass http://django;
                  proxy_set_header Host $host;
                  proxy_set_header X-Real-IP $remote_addr;
                  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto $scheme;
                  proxy_connect_timeout 300s;
                  proxy_read_timeout 300s;
              }
          }
        mode: '0644'

    - name: Restart Nginx container to apply SSL configuration
      command: docker compose restart nginx
      args:
        chdir: "{{ project_root }}/app/docker"

    - name: Wait for Nginx to be ready on HTTPS
      wait_for:
        port: 443
        host: localhost
        timeout: 30

    - name: Test HTTPS endpoint (ignore self-signed cert warning)
      command: curl -k -f https://localhost/health/
      register: https_check
      retries: 5
      delay: 3
      until: https_check.rc == 0

    - name: Display HTTPS check result
      debug:
        msg: 
          - "✅ HTTPS is working!"
          - "Response: {{ https_check.stdout }}"

    - name: Display success message
      debug:
        msg:
          - "==========================================="
          - "✅ SSL/TLS configured successfully!"
          - "==========================================="
          - "Certificate: Self-signed (valid 365 days)"
          - "HTTPS URL: https://{{ domain_name }}"
          - ""
          - "⚠️  Note: Browser will show security warning"
          - "    because this is a self-signed certificate."
          - "    In production, use Let's Encrypt (playbook 04-ssl-letsencrypt.yml)"
          - "==========================================="
