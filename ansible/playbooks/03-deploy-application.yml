---
# Playbook 03: Deploy Application
# Deploys the Django application with Docker Compose
# - Clones Git repository
# - Generates .env file from Vault variables
# - Builds and starts Docker containers
# - Runs Django migrations
# - Creates superuser

- name: Deploy Django application
  hosts: all
  become: yes
  become_user: "{{ deploy_user }}"
  gather_facts: yes

  tasks:
    - name: Display deployment information
      debug:
        msg: "Deploying {{ project_name }} {% if use_local_source | default(false) %}from local source{% else %}from {{ git_repo_url }}{% endif %}"

    # === DEV MODE: Copy files from local machine ===
    - name: Sync local source to remote (dev mode)
      synchronize:
        src: "{{ local_project_path }}/"
        dest: "{{ project_root }}/app/"
        delete: yes
        rsync_opts:
          - "--exclude=.git"
          - "--exclude=venv"
          - "--exclude=__pycache__"
          - "--exclude=*.pyc"
          - "--exclude=.env"
          - "--exclude=docker/logs"
          - "--exclude=docker/nginx/ssl"
      when: use_local_source | default(false) | bool

    - name: Display sync status (dev mode)
      debug:
        msg: "Local files synced to {{ project_root }}/app"
      when: use_local_source | default(false) | bool

    # === PRODUCTION MODE: Clone from Git ===
    - name: Clone or update Git repository
      git:
        repo: "{{ git_repo_url }}"
        dest: "{{ project_root }}/app"
        version: "{{ git_branch }}"
        force: yes
      register: git_result
      when: not (use_local_source | default(false) | bool)

    - name: Display Git status
      debug:
        msg: "Repository cloned/updated. Current HEAD: {{ git_result.after }}"
      when: not (use_local_source | default(false) | bool)

    - name: Generate .env file from Vault variables
      template:
        src: ../templates/env.j2
        dest: "{{ project_root }}/app/docker/.env"
        mode: '0600'

    - name: Stop existing containers (if any)
      command: docker compose down
      args:
        chdir: "{{ project_root }}/app/docker"
      ignore_errors: yes

    - name: Create logs directory with correct permissions
      become: yes
      become_user: root
      file:
        path: "{{ project_root }}/app/docker/logs"
        state: directory
        owner: 1000
        group: 1000
        mode: '0755'

    - name: Build Docker images
      command: docker compose build --no-cache
      args:
        chdir: "{{ project_root }}/app/docker"
      register: build_result

    - name: Start Docker containers
      command: docker compose up -d
      args:
        chdir: "{{ project_root }}/app/docker"
      register: compose_up_result

    - name: Fix logs directory permissions (after container creation)
      become: yes
      become_user: root
      file:
        path: "{{ project_root }}/app/docker/logs"
        state: directory
        owner: 1000
        group: 1000
        mode: '0755'
        recurse: yes

    - name: Restart Django container to apply permissions
      command: docker compose restart django-app
      args:
        chdir: "{{ project_root }}/app/docker"

    - name: Wait for Django health endpoint
      command: curl -sf http://localhost/health/
      register: health_check
      until: health_check.rc == 0
      retries: 30
      delay: 5

    - name: Display container status
      debug:
        var: compose_ps.stdout_lines

    - name: Create Django superuser (if not exists)
      command: >
        docker compose exec -T django-app
        python manage.py shell -c
        "from django.contrib.auth import get_user_model;
        User = get_user_model();
        User.objects.filter(username='{{ django_superuser_username }}').exists() or
        User.objects.create_superuser('{{ django_superuser_username }}',
        '{{ django_superuser_email }}',
        '{{ django_superuser_password }}')"
      args:
        chdir: "{{ project_root }}/app/docker"
      ignore_errors: yes

    - name: Test Django healthcheck endpoint
      uri:
        url: "http://localhost/health/"
        return_content: yes
        timeout: 10
      register: health_check
      retries: 5
      delay: 2
      until: health_check.status == 200

    - name: Display healthcheck result
      debug:
        msg: "Health check status: {{ health_check.json.status }}"

    - name: Display success message
      debug:
        msg: "Application deployed successfully! Accessible at http://{{ domain_name }}"
