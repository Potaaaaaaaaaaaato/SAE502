services:
  # ============================================================================
  # PostgreSQL Database
  # ============================================================================
  postgresql:
    image: postgres:16-alpine
    container_name: sae502_postgresql
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${DB_NAME:-django_db}
      POSTGRES_USER: ${DB_USER:-user}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-password}
      POSTGRES_INITDB_ARGS: "--encoding=UTF8 --locale=C"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - django_network
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U ${DB_USER:-user} -d ${DB_NAME:-django_db}" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================================================
  # Redis Cache & Celery Broker
  # ============================================================================
  redis:
    image: redis:7-alpine
    container_name: sae502_redis
    restart: unless-stopped
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data
    networks:
      - django_network
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 5s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================================================
  # Django Application + Gunicorn
  # ============================================================================
  django-app:
    build:
      context: ..
      dockerfile: docker/django/Dockerfile
    container_name: sae502_django
    restart: unless-stopped
    environment:
      # Django settings
      DEBUG: ${DEBUG:-False}
      DJANGO_SECRET_KEY: ${DJANGO_SECRET_KEY}
      ALLOWED_HOSTS: ${ALLOWED_HOSTS:-localhost,127.0.0.1}
      DJANGO_SETTINGS_MODULE: SAE502.settings

      # Database
      DB_ENGINE: ${DB_ENGINE:-django.db.backends.postgresql}
      DB_NAME: ${DB_NAME:-django_db}
      DB_USER: ${DB_USER:-user}
      DB_PASSWORD: ${DB_PASSWORD:-password}
      DB_HOST: postgresql
      DB_PORT: ${DB_PORT:-5432}

      # Redis
      REDIS_URL: redis://:${REDIS_PASSWORD:-}@redis:6379/0
      REDIS_HOST: redis
      REDIS_PORT: 6379

      # Email
      EMAIL_BACKEND: ${EMAIL_BACKEND:-django.core.mail.backends.console.EmailBackend}
      EMAIL_HOST: ${EMAIL_HOST:-smtp.gmail.com}
      EMAIL_PORT: ${EMAIL_PORT:-587}
      EMAIL_USE_TLS: ${EMAIL_USE_TLS:-True}
      EMAIL_HOST_USER: ${EMAIL_HOST_USER:-}
      EMAIL_HOST_PASSWORD: ${EMAIL_HOST_PASSWORD:-}
      DEFAULT_FROM_EMAIL: ${DEFAULT_FROM_EMAIL:-noreply@sae502.com}

      # Security
      SECURE_SSL_REDIRECT: ${SECURE_SSL_REDIRECT:-True}
      SESSION_COOKIE_SECURE: ${SESSION_COOKIE_SECURE:-True}
      CSRF_COOKIE_SECURE: ${CSRF_COOKIE_SECURE:-True}
      HSTS_SECONDS: ${HSTS_SECONDS:-31536000}

      # Gunicorn (used if not overridden in CMD)
      GUNICORN_WORKERS: ${GUNICORN_WORKERS:-2}
      GUNICORN_BIND: ${GUNICORN_BIND:-0.0.0.0:8000}
      GUNICORN_TIMEOUT: ${GUNICORN_TIMEOUT:-300}

      # Optional: Auto-create superuser on first run
      DJANGO_SUPERUSER_USERNAME: ${DJANGO_SUPERUSER_USERNAME:-}
      DJANGO_SUPERUSER_EMAIL: ${DJANGO_SUPERUSER_EMAIL:-}
      DJANGO_SUPERUSER_PASSWORD: ${DJANGO_SUPERUSER_PASSWORD:-}
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8000/health/" ]
      interval: 10s
      timeout: 5s
      retries: 12
      start_period: 20s
    volumes:
      - static_volume:/app/staticfiles
      - media_volume:/app/mediafiles
      - ./logs:/app/logs
    depends_on:
      postgresql:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - django_network
    expose:
      - "8000"
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================================================
  # Nginx Reverse Proxy
  # ============================================================================
  nginx:
    build:
      context: ./nginx
      dockerfile: Dockerfile
    container_name: sae502_nginx
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - static_volume:/app/staticfiles:ro
      - media_volume:/app/mediafiles:ro
      - ./nginx/ssl:/etc/letsencrypt:ro
      - ./nginx/certbot:/var/www/certbot:ro
      - docs_volume:/app/docs:ro
    depends_on:
      - django-app
    networks:
      - django_network
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================================================
  # Monitoring & Health Checks
  # ============================================================================
  monitoring:
    build:
      context: ./monitoring
      dockerfile: Dockerfile
    container_name: sae502_monitoring
    restart: unless-stopped
    environment:
      # Monitoring configuration
      MONITORING_ENABLED: ${MONITORING_ENABLED:-True}
      ALERT_EMAIL: ${ALERT_EMAIL:-}
      WEBHOOK_URL: ${WEBHOOK_URL:-}

      # Email settings for alerts
      EMAIL_HOST: ${EMAIL_HOST:-smtp.gmail.com}
      EMAIL_PORT: ${EMAIL_PORT:-587}
      EMAIL_HOST_USER: ${EMAIL_HOST_USER:-}
      EMAIL_HOST_PASSWORD: ${EMAIL_HOST_PASSWORD:-}

      # Service endpoints to monitor
      DJANGO_URL: http://django-app:8000
      DB_HOST: postgresql
      DB_PORT: 5432
      DB_NAME: ${DB_NAME:-django_db}
      DB_USER: ${DB_USER:-user}
      DB_PASSWORD: ${DB_PASSWORD:-password}
      REDIS_HOST: redis
      REDIS_PORT: 6379
    depends_on:
      - django-app
      - postgresql
      - redis
    networks:
      - django_network
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

# ==============================================================================
# Networks
# ==============================================================================
networks:
  django_network:
    driver: bridge
    name: sae502_network

# ==============================================================================
# Volumes
# ==============================================================================
volumes:
  postgres_data:
    name: sae502_postgres_data
  redis_data:
    name: sae502_redis_data
  static_volume:
    name: sae502_static
  media_volume:
    name: sae502_media
  docs_volume:
    name: sae502_docs
